// Generated by CoffeeScript 1.12.7
(function() {
  var check_current_page, update_active_tab, update_icon, update_tags;

  update_icon = function(has_color, tab_id) {
    return browser.browserAction.setIcon({
      path: has_color ? {
        48: '../pic/cn_1.png'
      } : {
        48: '../pic/cn_0.png'
      },
      tabId: tab_id
    });
  };

  check_current_page = function(tab) {
    return get_item({
      url: tab.url
    }, function(result) {
      if (result['stat'] === Status.COMPLETE) {
        return update_icon(true, tab.id);
      } else if (result['stat'] === Status.ERROR) {
        return update_icon(false, tab.id);
      }
    });
  };

  update_active_tab = function() {
    return browser.tabs.query({
      active: true,
      currentWindow: true
    }).then(function(tabs) {
      if (tabs[0]) {
        return check_current_page(tabs[0]);
      }
    });
  };

  update_tags = function(result) {
    if (result['stat'] === Status.COMPLETE) {
      return browser.storage.local.set({
        serial: result['msg'],
        tags: result['obj']
      });
    }
  };

  browser.tabs.onUpdated.addListener(update_active_tab);

  browser.tabs.onActivated.addListener(update_active_tab);

  setInterval((function() {
    var tag_serial;
    tag_serial = browser.storage.local.get('serial');
    return tag_serial.then(function(result) {
      return get_tags(result, update_tags);
    });
  }), 60000);

}).call(this);
