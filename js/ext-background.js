// Generated by CoffeeScript 1.12.7
(function() {
  var checkCurrentPage, fetchTagStat, updateActiveTab, updateTags, update_icon;

  update_icon = function(has_color, tab_id) {
    return browser.browserAction.setIcon({
      path: has_color ? {
        48: '../pic/cn_1.png'
      } : {
        48: '../pic/cn_0.png'
      },
      tabId: tab_id
    });
  };

  checkCurrentPage = function(tab) {
    return get_item({
      url: tab.url
    }, function(result) {
      if (result['stat'] === Status.COMPLETE) {
        return update_icon(true, tab.id);
      } else if (result['stat'] === Status.ERROR) {
        return update_icon(false, tab.id);
      }
    });
  };

  updateActiveTab = function() {
    return browser.tabs.query({
      active: true,
      currentWindow: true
    }).then(function(tabs) {
      if (tabs[0]) {
        return checkCurrentPage(tabs[0]);
      }
    });
  };

  updateTags = function(result) {
    if (result['stat'] === Status.COMPLETE) {
      return browser.storage.local.set({
        serial: result['msg'],
        tags: result['obj']
      });
    }
  };

  fetchTagStat = function() {
    var tagSerial;
    tagSerial = browser.storage.local.get('serial');
    return tagSerial.then(function(result) {
      return get_tags(result, updateTags);
    });
  };

  browser.tabs.onUpdated.addListener(updateActiveTab);

  browser.tabs.onActivated.addListener(updateActiveTab);

  fetchTagStat();

  setInterval((function() {
    return fetchTagStat();
  }), 60000);

}).call(this);
